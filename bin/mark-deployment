#!/usr/bin/env php
<?php

$argc = count($_SERVER['argv']);

if ($argc < 3 || $argc > 5) {
	echo 'Usage: mark-deployment <name> <version> [<duration> [<calendar>]]';
	exit(1);
}

$name     = $_SERVER['argv'][1];
$version  = $_SERVER['argv'][2];
$duration = $argc >= 4 ? $_SERVER['argv'][3] : '15';
$calendar = $argc >= 5 ? $_SERVER['argv'][4] : 'Deployments';

// Generate summary
$summary = "âœ” $name @ $version";

// Duration to time
$parts = array_reverse(explode(':', $duration));
$durationSeconds = 0;

foreach ($parts as $index => $part) {
	$durationSeconds += pow(60, $index+1) * $part;
}

// Calculate start and end date
$rfc2445 = '%A, %B %d, %Y at %T';
$interval15 = 15 * 60;

$endTime   = time() - (time() % $interval15) + $interval15;
$startTime = $endTime - $durationSeconds;

$startDate = strftime($rfc2445, $startTime);
$endDate   = strftime($rfc2445, $endTime);

echo <<<EOF
$summary
    Start Date: $startDate
    End Date: $endDate

EOF;

$event = <<<EOE
tell application "Calendar"
	tell (first calendar whose name is "$calendar")
		make new event at end of events with properties {start date:date "$startDate", end date:date "$endDate", summary:"$summary"}
	end tell
end tell
EOE;

shell_exec('osascript -e "'. addcslashes($event, '"') .'"');
